# Конфигурация спиллинга

[Спиллинг](../../concepts/spilling.md) — это механизм управления памятью в {{ ydb-short-name }}, который временно сохраняет данные на диск при нехватке оперативной памяти. Данный раздел описывает параметры конфигурации для настройки спиллинга в продакшн-среде.

## Первичные параметры конфигурации

### Сервис спиллинга (spilling_service_config)

**Расположение:** `table_service_config.spilling_service_config`

Основная конфигурация сервиса спиллинга определяется в секции `spilling_service_config`:

```yaml
table_service_config:
  spilling_service_config:
    local_file_config:
      root: ""
      max_total_size: 21474836480    # 20 GiB
      io_thread_pool:
        workers_count: 2
        queue_size: 1000
```

#### local_file_config.root

**Тип:** `string`  
**По умолчанию:** `""` (автоматическое определение)  
**Описание:** Директория файловой системы для сохранения файлов спиллинга. При пустом значении система автоматически создает директорию в формате `{TMP}/spilling-tmp-<username>`.

- `{TMP}` — временная директория системы, определяется из переменной окружения `TMPDIR` или стандартных системных путей
- `<username>` — имя пользователя, под которым запущен процесс `ydbd`

Для каждого процесса `ydbd` создается отдельная директория с уникальным именем. Директории спиллинга имеют следующий формат имени:

`node_<node_id>_<spilling_service_id>`

Где:

- `node_id` — идентификатор [узла](../../concepts/glossary.md#node)
- `spilling_service_id` — уникальный идентификатор экземпляра, который создается при инициализации [Spilling Service](../../contributor/spilling-service.md) один раз при старте процесса ydbd

Внутри каждой такой директории хранятся файлы спиллинга.

Пример полного пути к директории спиллинга:

```bash
/tmp/spilling-tmp-user/node_1_32860791-037c-42b4-b201-82a0a337ac80
```

##### Важные особенности

- При старте процесса все существующие директории спиллинга в указанной директории удаляются автоматически. При старте нового процесса удаляются все директории спиллинга, которые соответствуют формату имени, но имеют отличный от текущего `spilling_service_id`.
- Директория должна иметь достаточные права для записи и чтения от имени пользователя, от которого запущен ydbd.
- Несколько нод могут использовать одну и ту же директорию для спиллинга.

##### Рекомендации

- Используйте отдельный диск или раздел для спиллинга
- Предпочтительно использовать быстрые накопители (SSD/NVMe)
- Убедитесь в наличии достаточного свободного места

##### Возможные ошибки

- `Permission denied` — недостаточные права доступа к директории. См. [{#T}](../../troubleshooting/spilling.md#permission-denied)

#### local_file_config.max_total_size

**Тип:** `uint64`  
**По умолчанию:** `21474836480` (20 GiB)  
**Описание:** Максимальный суммарный размер всех файлов спиллинга. При превышении лимита операции спиллинга завершаются ошибкой.

##### Рекомендации

- Устанавливайте значение исходя из доступного дискового пространства

##### Возможные ошибки

- `Total size limit exceeded: X/YMb` — превышен максимальный суммарный размер файлов спиллинга. См. [{#T}](../../troubleshooting/spilling.md#total-size-limit-exceeded)

### Конфигурация пула потоков

{% note info %}

Потоки пула I/O для спиллинга создаются дополнительно к потокам, выделяемым для [акторной системы](../../concepts/glossary.md#actor-system). При планировании количества потоков учитывайте общую нагрузку на систему.

{% endnote %}

#### local_file_config.io_thread_pool.workers_count

**Тип:** `uint32`  
**По умолчанию:** `2`  
**Описание:** Количество рабочих потоков для обработки операций ввода-вывода спиллинга.

##### Рекомендации

- Увеличивайте для высоконагруженных систем
- Учитывайте количество CPU-ядер на сервере

##### Возможные ошибки

- `Can not run operation` — переполнение очереди операций в пуле потоков I/O. См. [{#T}](../../troubleshooting/spilling.md#can-not-run-operation)

#### local_file_config.io_thread_pool.queue_size

**Тип:** `uint32`  
**По умолчанию:** `1000`  
**Описание:** Размер очереди операций спиллинга. Каждая задача отправляет только один блок данных на спиллинг одновременно, поэтому большие значения обычно не требуются.

##### Возможные ошибки

- `Can not run operation` — переполнение очереди операций в пуле потоков I/O. См. [{#T}](../../troubleshooting/spilling.md#can-not-run-operation)

## Управление памятью

### Связь с memory_controller_config

Активация спиллинга тесно связана с настройками контроллера памяти. Подробная конфигурация `memory_controller_config` описана в [отдельной статье](../../reference/configuration/index.html#memory-controller).

Ключевым параметром для спиллинга является **`activities_limit_percent`**, который определяет объем памяти, выделяемый для активностей по обработке запросов. От этого параметра зависит доступная память для пользовательских запросов и, соответственно, частота активации спиллинга.

### Влияние на спиллинг

- При увеличении `activities_limit_percent` остается меньше памяти для выполнения запросов → спиллинг активируется чаще
- При уменьшении `activities_limit_percent` больше памяти доступно для запросов → спиллинг активируется реже

## Требования к файловой системе

### Файловые дескрипторы

{% note warning %}

Для корректной работы спиллинга в многоузловых кластерах рекомендуется увеличить лимит одновременно открытых файловых дескрипторов до 10000. Для небольших кластеров (1-3 узла) данная настройка обычно не требуется.

{% endnote %}

Для изменения лимита файловых дескрипторов добавьте следующие строки в файл `/etc/security/limits.conf`:

```bash
ydb soft nofile 10000
ydb hard nofile 10000
```

Где `ydb` — имя пользователя, под которым запускается `ydbd`.

После изменения файла необходимо перезагрузить систему или перелогиниться для применения новых лимитов.

## Примеры конфигурации

### Высоконагруженная система

Для максимальной производительности в высоконагруженных системах рекомендуется увеличить размер спиллинга и количество рабочих потоков:

```yaml
table_service_config:
  spilling_service_config:
    local_file_config:
      root: ""
      max_total_size: 107374182400   # 100 GiB
      io_thread_pool:
        workers_count: 8
        queue_size: 2000
```

### Ограниченные ресурсы

Для систем с ограниченными ресурсами рекомендуется использовать консервативные настройки:

```yaml
table_service_config:
  spilling_service_config:
    local_file_config:
      root: ""
      max_total_size: 5368709120     # 5 GiB
      io_thread_pool:
        workers_count: 1
        queue_size: 500
```

## Расширенная конфигурация

### Включение и отключение спиллинга

Следующие параметры управляют включением и отключением различных типов спиллинга. Обычно их следует изменять только при наличии специфических требований к системе.

#### local_file_config.enable

**Расположение:** `table_service_config.spilling_service_config.local_file_config.enable`
**Тип:** `boolean`  
**По умолчанию:** `true`  
**Описание:** Включает или отключает сервис спиллинга. При отключении (`false`) [спиллинг](../../concepts/spilling.md) не функционирует, что может привести к ошибкам при нехватке памяти.

##### Возможные ошибки

- `Spilling Service not started` / `Service not started` — попытка использования спиллинга при выключенном Spilling Service. См. [{#T}](../../troubleshooting/spilling.md#spilling-service-not-started)

```yaml
table_service_config:
  spilling_service_config:
    local_file_config:
      enable: true
```

#### enable_query_service_spilling

**Расположение:** `table_service_config.enable_query_service_spilling`  
**Тип:** `boolean`  
**По умолчанию:** `true`  
**Описание:** Глобальная опция, включающая спиллинг в каналах передачи данных между задачами.

```yaml
table_service_config:
  enable_query_service_spilling: true
```

**Важно:** Эта настройка работает совместно с локальной конфигурацией сервиса спиллинга. При отключении (`false`) спиллинг в каналах не функционирует даже при включенном `spilling_service_config`.

#### enable_spilling_nodes

**Расположение:** `table_service_config.enable_spilling_nodes`  
**Тип:** `string`  
**Возможные значения:** `"All"` | `"GraceJoin"` | `"Aggregate"` | `"None"`  
**По умолчанию:** `"All"`  
**Описание:** Управляет включением спиллинга в вычислительных узлах.

```yaml
table_service_config:
  enable_spilling_nodes: "All"
```

## Полный пример

```yaml
table_service_config:
  enable_query_service_spilling: true
  enable_spilling_nodes: "All"
  spilling_service_config:
    local_file_config:
      enable: true
      root: ""
      max_total_size: 21474836480    # 20 GiB
      io_thread_pool:
        workers_count: 2
        queue_size: 1000
```

## См. также

- [Концепция спиллинга](../../concepts/spilling.md)
- [Конфигурация контроллера памяти](../../reference/configuration/index.html#memory-controller)
- [Мониторинг {{ ydb-short-name }}](../../devops/observability/monitoring.md)
- [Диагностика производительности](../../troubleshooting/performance/index.md)
- [Устранение неполадок спиллинга](../../troubleshooting/spilling.md)