# Конфигурация спиллинга

## Обзор

[Спиллинг](../../../concepts/spilling.md) — это механизм управления памятью в YDB, который позволяет временно сохранять данные на диск при нехватке оперативной памяти. Данный раздел описывает параметры конфигурации для настройки спиллинга в продакшн-среде.

Все настройки спиллинга находятся в секции `table_service_config`, которая располагается на том же уровне, что и `host_configs`.

```yaml
table_service_config:
  enable_query_service_spilling: true
  enable_spilling_nodes: "All"
  spilling_service_config:
    local_file_config:
      enable: true
      root: "/var/ydb/spill"
      max_total_size: 21474836480    # 20 GiB
      max_file_size: 5368709120      # 5 GiB
      max_file_part_size: 104857600  # 100 MB
      io_thread_pool:
        workers_count: 2
        queue_size: 1000
  resource_manager:
    spilling_percent: 80.0
```

## Глобальные настройки спиллинга

### enable_query_service_spilling

**Расположение:** `table_service_config.enable_query_service_spilling`  
**Тип:** `boolean`  
**По умолчанию:** `true`  
**Описание:** Глобальная опция, включающая спиллинг в каналах передачи данных между задачами.

```yaml
table_service_config:
  enable_query_service_spilling: true
```

**Важно:** Эта настройка работает совместно с локальной конфигурацией сервиса спиллинга. При отключении (`false`) спиллинг в каналах не функционирует даже при включенном `spilling_service_config`.

### enable_spilling_nodes

**Расположение:** `table_service_config.enable_spilling_nodes`  
**Тип:** `string`  
**Возможные значения:** `"All"` | `"GraceJoin"` | `"Aggregate"` | `"None"`  
**По умолчанию:** `"All"`  
**Описание:** Управляет включением спиллинга в вычислительных узлах.

```yaml
table_service_config:
  enable_spilling_nodes: "All"
```

## Основные параметры конфигурации

### Сервис спиллинга (spilling_service_config)

**Расположение:** `table_service_config.spilling_service_config`

Основная конфигурация сервиса спиллинга определяется в секции `spilling_service_config`:

```yaml
table_service_config:
  spilling_service_config:
    local_file_config:
      enable: true
      root: "/var/ydb/spill"
      max_total_size: 21474836480    # 20 GiB
      max_file_size: 5368709120      # 5 GiB
      max_file_part_size: 104857600  # 100 MB
      io_thread_pool:
        workers_count: 2
        queue_size: 1000
```

#### Enable (обязательный параметр)

**Тип:** `boolean`  
**По умолчанию:** `true`  
**Описание:** Включает или отключает сервис спиллинга. При отключении (`false`) [спиллинг](../../../concepts/spilling.md) не функционирует, что может привести к ошибкам Out of Memory при обработке больших объемов данных.

**Рекомендации:**
- Всегда устанавливайте в `true` для продакшн-сред
- Отключайте только для тестирования или отладки

#### Root

**Тип:** `string`  
**По умолчанию:** `""` (автоматическое определение)  
**Описание:** Директория для сохранения файлов спиллинга. При пустом значении система автоматически создает директорию в формате `{TMP}/spilling-tmp-<username>`.

**Важные особенности:**
- При старте процесса все существующие файлы спиллинга в указанной директории удаляются автоматически
- Это предотвращает накопление файлов при аварийном завершении процессов
- Директория должна иметь достаточные права для записи

**Рекомендации:**
- Используйте отдельный диск или раздел для спиллинга
- Предпочтительно использовать быстрые накопители (SSD/NVMe)
- Убедитесь в наличии достаточного свободного места

#### MaxTotalSize

**Тип:** `uint64`  
**По умолчанию:** `21474836480` (20 GiB)  
**Описание:** Максимальный суммарный размер всех файлов спиллинга. При превышении лимита операции спиллинга завершаются ошибкой.

**Рекомендации:**
- Устанавливайте значение исходя из доступного дискового пространства
- Оставляйте резерв для других операций системы
- Мониторьте использование дискового пространства

#### MaxFileSize

**Тип:** `uint64`  
**По умолчанию:** `5368709120` (5 GiB)  
**Описание:** Максимальный размер одного файла спиллинга. Соответствует лимиту на размер спилленного блока данных (бакета).

**Контекст использования:**
- Одна задача WideCombiner может создавать до 128 файлов
- Одна задача GraceJoin может создавать до 64 файлов (32 × 2 стороны join)
- Один канал передачи данных создает 1 файл

#### MaxFilePartSize

**Тип:** `uint64`  
**По умолчанию:** `104857600` (100 MB)  
**Описание:** Максимальный размер одной части файла. Файлы спиллинга могут состоять из нескольких частей, каждая размером до `MaxFilePartSize`. Суммарный размер всех частей не должен превышать `MaxFileSize`.

### Конфигурация пула потоков (TIoThreadPoolConfig)

#### WorkersCount

**Тип:** `uint32`  
**По умолчанию:** `2`  
**Описание:** Количество рабочих потоков для обработки операций ввода-вывода спиллинга.

**Рекомендации:**
- Увеличивайте для высоконагруженных систем
- Учитывайте количество CPU-ядер на сервере
- Начинайте с значения по умолчанию и корректируйте по мониторингу

#### QueueSize

**Тип:** `uint32`  
**По умолчанию:** `1000`  
**Описание:** Размер очереди операций спиллинга. Каждая задача отправляет только один блок данных на спиллинг одновременно, поэтому большие значения обычно не требуются.

## Управление памятью

### Связь с memory_controller_config

Активация спиллинга тесно связана с настройками контроллера памяти. Подробная конфигурация `memory_controller_config` описана в [отдельной статье](../../../reference/configuration/index.md#memory-controller-config).

Ключевым параметром для спиллинга является **`activities_limit_percent`** (по умолчанию 30%), который определяет объем памяти, выделяемый для фоновых активностей. От этого параметра зависит доступная память для пользовательских запросов и, соответственно, частота активации спиллинга.

**Влияние на спиллинг:**
- При увеличении `activities_limit_percent` остается меньше памяти для выполнения запросов → спиллинг активируется чаще
- При уменьшении `activities_limit_percent` больше памяти доступно для запросов → спиллинг активируется реже

### spilling_percent в resource_manager

**Расположение:** `table_service_config.resource_manager.spilling_percent`  
**Тип:** `double`  
**По умолчанию:** `80.0`  
**Описание:** Процент использования лимита выполнения запросов, при достижении которого система начинает активировать спиллинг.

```yaml
table_service_config:
  resource_manager:
    spilling_percent: 80.0  # 80% от доступной памяти для запросов
```

**Влияние на производительность:**

- **Меньшие значения (60-70%):**
  - Спиллинг активируется раньше и чаще
  - Более надежная работа при ограниченной памяти
  - Потенциально более медленное выполнение запросов из-за частых операций ввода-вывода
  - Рекомендуется для критически важных систем

- **Большие значения (85-95%):**
  - Спиллинг активируется позже, при большем заполнении памяти
  - Более быстрое выполнение запросов в нормальных условиях
  - Повышенный риск ошибок нехватки памяти при пиковых нагрузках
  - Рекомендуется для высокопроизводительных систем с достаточным объемом памяти

**Рекомендации по настройке:**
- Начинайте с значения по умолчанию (80%)
- Уменьшайте при частых ошибках нехватки памяти
- Увеличивайте при стабильной работе для повышения производительности
- Мониторьте использование памяти и частоту активации спиллинга

### Взаимосвязь настроек памяти и спиллинга

Порог активации спиллинга зависит от настроек `memory_controller_config` и `spilling_percent`:

1. **Доступная память для запросов** определяется параметрами в `memory_controller_config`
2. **Порог спиллинга** = доступная память × `spilling_percent` / 100

**Пример:**
Если после настройки `memory_controller_config` для запросов доступно 32 GiB памяти, а `spilling_percent = 80`, то спиллинг начнет активироваться при использовании ~25.6 GiB памяти.

## Требования к файловой системе

### Файловые дескрипторы

Для корректной работы спиллинга необходимо увеличить лимит одновременно открытых файловых дескрипторов.

**Расчет количества файлов:**
- WideCombiner: до 128 файлов на задачу
- GraceJoin: до 64 файлов на задачу (32 × 2)
- Каналы: 1 файл на канал

**Рекомендуемые настройки системы:**
```bash
# В /etc/security/limits.conf
ydb soft nofile 65536
ydb hard nofile 65536

# Или через systemd
LimitNOFILE=65536
```

## Мониторинг и диагностика

### Ключевые метрики

Рекомендуется отслеживать следующие метрики:

- Использование дискового пространства в директории спиллинга
- Количество активных операций спиллинга
- Время выполнения операций ввода-вывода
- Частота срабатывания лимитов

### Логирование

Включите логирование операций спиллинга для диагностики:

```yaml
logging:
  level: INFO
  components:
    - name: "SPILLING"
      level: DEBUG
```

## Примеры конфигурации

### Высоконагруженная система

```yaml
table_service_config:
  enable_query_service_spilling: true
  enable_spilling_nodes: "All"
  spilling_service_config:
    local_file_config:
      enable: true
      root: "/ssd/ydb/spill"
      max_total_size: 107374182400   # 100 GiB
      max_file_size: 10737418240     # 10 GiB
      max_file_part_size: 1073741824 # 1 GiB
      io_thread_pool:
        workers_count: 8
        queue_size: 2000
  resource_manager:
    spilling_percent: 85.0
```

### Ограниченные ресурсы

```yaml
table_service_config:
  enable_query_service_spilling: true
  enable_spilling_nodes: "GraceJoin"  # Только для join операций
  spilling_service_config:
    local_file_config:
      enable: true
      root: "/var/ydb/spill"
      max_total_size: 5368709120     # 5 GiB
      max_file_size: 1073741824      # 1 GiB
      max_file_part_size: 52428800   # 50 MB
      io_thread_pool:
        workers_count: 1
        queue_size: 500
  resource_manager:
    spilling_percent: 75.0
```

## Устранение неполадок

### Частые проблемы

1. **Ошибки нехватки места на диске**
   - Увеличьте `MaxTotalSize` или освободите место в директории спиллинга
   - Проверьте настройки ротации логов

2. **Высокая задержка операций**
   - Переместите директорию спиллинга на более быстрый диск
   - Увеличьте `WorkersCount` в пуле потоков

3. **Ошибки файловых дескрипторов**
   - Увеличьте системные лимиты на количество открытых файлов
   - Оптимизируйте `MaxFilePartSize` для уменьшения количества файлов

## См. также

- [Концепция спиллинга](../../../concepts/spilling.md)
- [Конфигурация контроллера памяти](../../../reference/configuration/index.md#memory-controller-config)
- [Мониторинг YDB](../../maintenance/monitoring.md)
- [Настройка производительности](../performance-tuning.md) 